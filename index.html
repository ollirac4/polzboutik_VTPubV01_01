<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestion Visites Tech V24</title>
    
    <link rel="apple-touch-icon" href="vtpub-icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VT PUB">

    <style>
        :root {
            --primary: #4a90e2;
            --danger: #e74c3c;
            --success: #2ecc71;
            --light: #f4f4f9;
            --dark: #333;
            --border: #ddd;
            --accent: #f39c12;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--light); color: var(--dark); }

        /* √âcrans */
        .screen { display: none; padding: 20px; margin: 0 auto; }
        .screen.active { display: block; }

        #screen-edit-inventory, #screen-project { padding: 0; }
        .screen-content { padding: 20px; }

        /* Ent√™te Fixe Inventaire */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--light);
            padding: 20px 20px 0px 20px;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .sticky-table-header {
            background: white;
            margin: 10px -20px 0 -20px;
            padding: 0 20px;
        }

        /* Cards Style */
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid var(--accent); }
        .card-info { flex-grow: 1; cursor: pointer; }
        .card-name { font-weight: bold; font-size: 1.1em; color: var(--primary); }
        .card-meta { font-size: 0.8em; color: #777; margin-top: 4px; }
        .actions { display: flex; gap: 8px; }

        /* Interface Projet */
        .navbar { display: flex; background: white; border-bottom: 1px solid var(--border); position: sticky; top: 41px; z-index: 999; }
        .nav-item { flex: 1; padding: 18px 5px; text-align: center; cursor: pointer; font-weight: bold; color: #555; border-bottom: 4px solid transparent; font-size: 11px; text-transform: uppercase; }
        .nav-item.active { background-color: var(--primary); color: white; border-bottom: 4px solid #2a6cb3; }

        /* Boutons Style */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; justify-content: center; font-size: 13px; text-decoration: none; }
        .btn-add { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-sep { background-color: #607d8b; }
        .btn-subtle { background: #dcdde1; color: #2f3640; border: 1px solid #bdc3c7; width: 32px; height: 32px; padding: 0; }

        /* Tables & Inputs */
        input[type="text"], input[type="number"], select, .editable-cell { 
            padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; background: white;
        }
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: auto; border-collapse: collapse; min-width: 100%; }
        th { background: #f1f1f1; padding: 10px 5px; font-size: 0.7em; text-transform: uppercase; border-bottom: 2px solid #ddd; text-align: left; color: #666; }
        td { padding: 5px; border-bottom: 1px solid #eee; vertical-align: middle; }

        .rank-input { width: 60px !important; text-align: center; font-weight: bold; background: #f9f9f9 !important; border: 1px solid #ccc !important; }
        .name-input { width: 100% !important; border: 1px solid #ccc !important; }
        .val-input { width: 65px !important; text-align: center; border: 1px solid #ccc !important; }

        .no-spinners::-webkit-outer-spin-button, .no-spinners::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .no-spinners { -moz-appearance: textfield; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }
        .switch-container { display: flex; align-items: center; gap: 8px; font-size: 0.7em; font-weight: bold; color: #666; }

        /* Drag & Drop */
        .drag-handle { cursor: grab; font-size: 18px; color: #ccc; visibility: hidden; }
        .reorder-active .drag-handle { visibility: visible; }
        tr.dragging { opacity: 0.5; background: #e3f2fd; border: 2px dashed var(--primary); }

        /* Affichage Colonnes Listes */
        #listsWrapper { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; align-items: flex-start; }
        .list-container { min-width: 480px; background: #fff; border-radius: 8px; padding: 15px; border-top: 4px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Grille: Nom/Suppr | Prix | Desc | Total | +/- */
        .list-grid-row { display: grid; grid-template-columns: 1fr 85px 65px 75px 100px; align-items: center; gap: 5px; }
        
        .list-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .list-title-area { flex: 1; min-width: 0; }
        .list-finance-controls { display: flex; align-items: center; gap: 5px; }

        .price-col-cell { text-align: right; font-size: 0.85em; }
        .discount-input, .price-input { width: 100% !important; padding: 4px !important; text-align: center; font-size: 0.85em; border: 1px solid #ccc; border-radius: 4px; }
        .override { border: 2px solid var(--accent) !important; }
        
        .total-list-display { font-size: 1.1em; font-weight: bold; color: var(--dark); text-align: right; min-width: 75px; }
        .hide-finance .finance-ui { display: none !important; }
        .hide-finance .list-grid-row { grid-template-columns: 1fr 100px; }

        .btn-view { background: none; border: none; cursor: pointer; font-size: 1.1em; filter: grayscale(1); transition: 0.2s; padding: 0; margin-left: 5px; }
        .btn-view.active { filter: grayscale(0); }
        .btn-apply-all { background: white; color: var(--accent); border: 1px solid var(--accent); border-radius: 50%; cursor: pointer; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; }

        .suggestions { position: absolute; background: white; width: 100%; z-index: 100; border: 1px solid #ccc; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .list-separator-view { background: #dfe6e9; padding: 4px; margin: 10px 0; border-radius: 4px; font-size: 0.7em; color: #2d3436; font-weight: bold; text-align: center; text-transform: uppercase; }

        /* Bande noire iPad optimis√©e */
        .active-project-banner { background: #2d3436; color: white; padding: 8px 15px; font-size: 0.9em; display: flex; align-items: center; position: sticky; top: 0; z-index: 1001; height: 35px; }
        
        .pre-add-container { display: flex; gap: 5px; margin-top: 5px; }
        .qty-picker { display: flex; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; background: #f1f1f1; }
        .qty-picker button { width: 35px; border: none; background: #eee; cursor: pointer; font-weight: bold; font-size: 16px; }
        .qty-picker input { width: 60px; border: none; text-align: center; background: white; font-weight: bold; font-size: 15px; padding: 5px 0; }

        /* Nouveaux styles pour boutons iPad */
        .ipad-qty-btn { width: 45px; height: 35px; font-size: 18px; border-radius: 6px; }
        .btn-delete-item { color: var(--danger); font-weight: bold; font-size: 18px; cursor: pointer; margin-left: 8px; border:none; background:none; padding:0; vertical-align: middle; }
        .copyright-text { font-size: 10px; opacity: 0.6; color: white; margin-left: auto; }
    </style>
</head>
<body>

<div id="screen-home" class="screen active" style="max-width:1200px; position: relative; min-height: 90vh;">
    <h1 style="text-align:center; color:var(--primary); margin-bottom:20px;">Visites Techniques</h1>
    <button class="btn btn-sep" style="width:100%; margin-bottom:30px; padding:15px; font-size:1.1em;" onclick="showScreen('screen-inventories')">üì¶ G√âRER LES INVENTAIRES</button>
    
    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <h3 style="margin-top:0;">Nouveau Projet</h3>
        <div style="display:flex; gap:10px;">
            <input type="text" id="newProjectName" placeholder="Nom du projet / Lieu..." style="flex-grow:1;">
            <button class="btn btn-add" onclick="createNewProject()">CR√âER</button>
        </div>
    </div>
    <h3 style="color:#555;">Mes Projets en cours</h3>
    <div id="projectList"></div>

    <div style="text-align: center; width: 100%; padding: 20px 0; color: #777; font-size: 12px; margin-top: 40px;">
        @ 2026 Olivier Racine
    </div>
</div>

<div id="screen-inventories" class="screen" style="max-width:1200px;">
    <div style="display:flex; align-items:center; background: #2d3436; color:white; padding: 10px 15px; margin: -20px -20px 20px -20px;">
        <div onclick="showScreen('screen-home')" style="cursor:pointer; font-size:1.4em; margin-right: 25px;">‚Üê</div>
        <h2 style="margin:0; font-size: 1.1em;">Inventaires</h2>
        <span class="copyright-text">@ 2026 Olivier Racine</span>
    </div>
    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display:flex; gap:10px;">
            <input type="text" id="newInvName" placeholder="Nom de l'inventaire..." style="flex-grow:1;">
            <button class="btn btn-add" onclick="createNewInventory()">CR√âER</button>
        </div>
    </div>
    <div id="inventoriesList"></div>
</div>

<div id="screen-edit-inventory" class="screen">
    <div class="sticky-header">
        <div style="display:flex; align-items:center; background: #2d3436; color:white; padding: 10px 15px; margin: -20px -20px 15px -20px;">
            <div onclick="showScreen('screen-inventories')" style="cursor:pointer; font-size:1.4em; margin-right: 25px;">‚Üê</div>
            <h2 id="editInvTitle" style="margin:0; font-size: 1.1em;">Modifier Inventaire</h2>
            <span class="copyright-text">@ 2026 Olivier Racine</span>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn btn-add" onclick="addInvRow()">+ ITEM</button>
                <button class="btn btn-sep" onclick="addInvSep()">+ S√âPARATEUR</button>
                <button class="btn" style="background:#6c757d;" onclick="toggleImportExport()">IMPORT / EXPORT</button>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="switch-container">
                    <span>R√âORGANISER</span>
                    <label class="switch">
                        <input type="checkbox" id="reorderToggle" onchange="toggleReorderMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="btn btn-danger" style="font-size:10px; background:#c0392b;" onclick="clearCurrentInventory()">EFFACER TOUT</button>
            </div>
        </div>
        <div id="importSection" style="display:none; background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:15px;">
            <textarea id="importText" style="width:100%; height:120px; font-family:monospace; font-size:12px; margin-bottom:10px;"></textarea>
            <button class="btn btn-add" style="width:100%;" onclick="processImport()">IMPORTER (√âCRASER TOUT)</button>
        </div>
        <div class="sticky-table-header">
            <table style="margin-bottom:0; box-shadow:none;">
                <thead>
                    <tr>
                        <th style="width:30px;"></th>
                        <th style="width:75px;">#</th>
                        <th>NOM / S√âPARATEUR</th>
                        <th style="width:70px;">PRIX</th>
                        <th style="width:70px;">STOCK</th>
                        <th style="width:35px;"></th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <div class="screen-content">
        <div class="table-container" style="border-top-left-radius:0; border-top-right-radius:0;">
            <table id="inventoryTable">
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="screen-project" class="screen">
    <div class="active-project-banner">
        <div onclick="showScreen('screen-home')" style="cursor:pointer; font-size:1.4em; margin-right:35px;">‚Üê</div> 
        <strong id="projDisplayTitle" style="cursor:pointer; margin-right: 20px;" onclick="renameCurrentProj()">Projet</strong>
        <div class="btn" style="background:#607d8b; padding:4px 10px; font-size:10px; border-radius:4px; margin-left:40px;" onclick="showScreen('screen-inventories')">üì¶ INVENTAIRES</div>
        <span class="copyright-text">@ 2026 Olivier Racine</span>
    </div>
    <div class="navbar">
        <div id="nav-listes" class="nav-item active" onclick="switchTab('listes')">LISTES</div>
        <div id="nav-finale" class="nav-item" onclick="switchTab('finale')">R√âCAPITULATIF</div>
    </div>
    <div id="tab-listes" class="tab-content active" style="padding:20px;">
        <div style="background:white; padding:15px; border-radius:8px; margin-bottom:25px; box-shadow:0 1px 3px rgba(0,0,0,0.1); max-width:700px;">
            <h4 style="margin:0 0 10px 0;">+ Nouvelle Liste</h4>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <input type="text" id="newListName" placeholder="Ex: Camion, Studio..." style="flex:1;">
                <select id="newListInvSource" style="flex:1;"></select>
                <button class="btn btn-add" onclick="createNewList()">AJOUTER</button>
            </div>
        </div>
        <div id="listsWrapper"></div>
    </div>
    <div id="tab-finale" class="tab-content" style="display:none; padding:20px;">
        <div style="display:flex; justify-content: flex-end; margin-bottom: 20px;">
            <button class="btn btn-subtle" style="width: auto; height: auto; padding: 8px 15px; font-size: 11px;" onclick="copyAllLists()">COPIER TOUTES LES LISTES</button>
        </div>
        <div id="finaleContent" style="max-width:800px; margin:0 auto;"></div>
    </div>
</div>

<script>
    let projects = JSON.parse(localStorage.getItem('vt_v24_projs')) || [];
    let inventories = JSON.parse(localStorage.getItem('vt_v24_invs')) || [];
    let currentProjId = null;
    let currentInvId = null;
    let draggedIdx = null;
    let reorderMode = false;
    let listSearchState = {}; 

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'screen-home') renderProjects();
        if(id === 'screen-inventories') renderInventories();
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-' + tab).style.display = 'block';
        document.getElementById('nav-' + tab).classList.add('active');
        if(tab === 'listes') renderProjectLists();
        if(tab === 'finale') renderFinale();
    }

    function createNewInventory() {
        const name = document.getElementById('newInvName').value.trim();
        if(!name) return;
        inventories.push({ id: 'inv_'+Date.now(), name: name, items: [] });
        document.getElementById('newInvName').value = '';
        save(); renderInventories();
    }

    function renderInventories() {
        const container = document.getElementById('inventoriesList');
        container.innerHTML = '';
        inventories.forEach(inv => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div class="card-info" onclick="openInventoryEditor('${inv.id}')">
                    <div class="card-name">${inv.name}</div>
                    <div class="card-meta">${inv.items.length} items</div>
                </div>
                <div class="actions">
                    <button class="btn btn-subtle" onclick="renameInv('${inv.id}')">‚úé</button>
                    <button class="btn btn-subtle" onclick="duplicateInv('${inv.id}')">‚ùê</button>
                    <button class="btn btn-danger" onclick="deleteInv('${inv.id}')">√ó</button>
                </div>`;
            container.appendChild(div);
        });
    }

    function openInventoryEditor(id) {
        currentInvId = id;
        reorderMode = false;
        document.getElementById('reorderToggle').checked = false;
        document.getElementById('importSection').style.display = 'none';
        const inv = inventories.find(i => i.id === id);
        document.getElementById('editInvTitle').textContent = inv.name;
        showScreen('screen-edit-inventory');
        renderInventoryEditor();
    }

    function toggleReorderMode() {
        reorderMode = document.getElementById('reorderToggle').checked;
        const table = document.getElementById('inventoryTable');
        if(reorderMode) table.classList.add('reorder-active');
        else table.classList.remove('reorder-active');
        renderInventoryEditor();
    }

    function renderInventoryEditor() {
        const inv = inventories.find(i => i.id === currentInvId);
        const tbody = document.getElementById('inventoryBody');
        tbody.innerHTML = '';
        inv.items.forEach((item, idx) => {
            const tr = document.createElement('tr');
            if(item.isSep) tr.className = 'row-separator';
            if(reorderMode) {
                tr.draggable = true;
                tr.addEventListener('dragstart', () => { draggedIdx = idx; tr.classList.add('dragging'); });
                tr.addEventListener('dragover', e => e.preventDefault());
                tr.addEventListener('drop', () => {
                    const moved = inv.items.splice(draggedIdx, 1)[0];
                    inv.items.splice(idx, 0, moved);
                    save(); renderInventoryEditor();
                });
                tr.addEventListener('dragend', () => tr.classList.remove('dragging'));
            }
            const safeName = item.name.replace(/"/g, '&quot;');
            tr.innerHTML = `
                <td style="width:30px;"><div class="drag-handle">‚â°</div></td>
                <td style="width:75px;"><input type="number" class="rank-input" value="${idx+1}" onchange="moveRank(${idx}, this.value-1)"></td>
                <td><input type="text" class="name-input" style="${item.isSep?'font-weight:bold; color:#607d8b;':''}" value="${safeName}" onchange="updateInvItem(${idx}, 'name', this.value)"></td>
                <td style="width:70px;">${item.isSep ? '-' : `<input type="number" step="0.01" class="val-input" value="${item.price}" onchange="updateInvItem(${idx}, 'price', this.value)">`}</td>
                <td style="width:70px;">${item.isSep ? '-' : `<input type="number" class="val-input" value="${item.stock}" onchange="updateInvItem(${idx}, 'stock', this.value)">`}</td>
                <td style="width:35px;" onclick="deleteInvItem(${idx})" style="color:red; cursor:pointer; font-size:18px; text-align:center;">√ó</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function deleteInvItem(idx) {
        const inv = inventories.find(i => i.id === currentInvId);
        inv.items.splice(idx, 1);
        save(); renderInventoryEditor();
    }

    function updateInvItem(idx, field, val) {
        const inv = inventories.find(i => i.id === currentInvId);
        inv.items[idx][field] = (field === 'name') ? val : parseFloat(val);
        save();
    }

    function moveRank(oldIdx, newIdx) {
        const inv = inventories.find(i => i.id === currentInvId);
        const item = inv.items.splice(oldIdx, 1)[0];
        inv.items.splice(Math.max(0, newIdx), 0, item);
        save(); renderInventoryEditor();
    }

    function addInvRow() {
        const inv = inventories.find(i => i.id === currentInvId);
        inv.items.push({ id: Date.now(), name: "Nouvel Item", price: 0, stock: 1, isSep: false });
        save(); renderInventoryEditor();
    }

    function addInvSep() {
        const inv = inventories.find(i => i.id === currentInvId);
        inv.items.push({ id: Date.now(), name: "--- SECTION ---", isSep: true });
        save(); renderInventoryEditor();
    }

    function duplicateInv(id) {
        const original = inventories.find(i => i.id === id);
        const clone = JSON.parse(JSON.stringify(original));
        clone.id = 'inv_' + Date.now();
        clone.name += " (Copie)";
        inventories.push(clone);
        save(); renderInventories();
    }

    function renameInv(id) {
        const inv = inventories.find(i => i.id === id);
        const n = prompt("Nom de l'inventaire :", inv.name);
        if(n) { inv.name = n; save(); renderInventories(); }
    }

    function createNewProject() {
        const name = document.getElementById('newProjectName').value.trim();
        if(!name) return;
        projects.push({ id: 'pj_'+Date.now(), name: name, date: new Date().toLocaleDateString('fr-FR'), lists: [] });
        document.getElementById('newProjectName').value = '';
        save(); renderProjects();
    }

    function renderProjects() {
        const container = document.getElementById('projectList');
        container.innerHTML = '';
        projects.forEach(p => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div class="card-info" onclick="openProject('${p.id}')">
                    <div class="card-name">${p.name}</div>
                    <div class="card-meta">Le ${p.date} ‚Ä¢ ${p.lists.length} listes</div>
                </div>
                <div class="actions">
                    <button class="btn btn-subtle" onclick="renameProj('${p.id}')">‚úé</button>
                    <button class="btn btn-subtle" onclick="duplicateProj('${p.id}')">‚ùê</button>
                    <button class="btn btn-danger" onclick="deleteProj('${p.id}')">√ó</button>
                </div>`;
            container.appendChild(div);
        });
    }

    function openProject(id) {
        currentProjId = id;
        const p = projects.find(proj => proj.id === id);
        document.getElementById('projDisplayTitle').textContent = p.name;
        const select = document.getElementById('newListInvSource');
        select.innerHTML = inventories.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
        showScreen('screen-project');
        switchTab('listes');
    }

    function renameProj(id) {
        const p = projects.find(proj => proj.id === id);
        const n = prompt("Nom du projet :", p.name);
        if(n) { p.name = n; save(); renderProjects(); if(currentProjId===id) document.getElementById('projDisplayTitle').textContent=n; }
    }
    function renameCurrentProj() { renameProj(currentProjId); }

    function duplicateProj(id) {
        const original = projects.find(p => p.id === id);
        const clone = JSON.parse(JSON.stringify(original));
        clone.id = 'pj_' + Date.now();
        clone.name += " (Copie)";
        projects.push(clone);
        save(); renderProjects();
    }

    function createNewList() {
        const name = document.getElementById('newListName').value.trim();
        const invId = document.getElementById('newListInvSource').value;
        if(!name || !invId) return;
        const p = projects.find(proj => proj.id === currentProjId);
        p.lists.push({ id: 'li_'+Date.now(), name: name, invSourceId: invId, selections: [], globalDiscount: 0, hideFinance: false });
        document.getElementById('newListName').value = '';
        save(); renderProjectLists();
    }

    function renderProjectLists() {
        const p = projects.find(proj => proj.id === currentProjId);
        const wrapper = document.getElementById('listsWrapper');
        wrapper.innerHTML = '';

        p.lists.forEach((list, lIdx) => {
            const inv = inventories.find(i => i.id === list.invSourceId) || { items: [] };
            const div = document.createElement('div');
            div.className = `list-container ${list.hideFinance ? 'hide-finance' : ''}`;
            
            div.innerHTML = `
                <div class="list-header-top">
                    <div class="list-title-area">
                        <strong>${list.name}</strong><br>
                        <small style="color:#4a90e2;">${inv.name}</small>
                        <button class="btn-view ${!list.hideFinance ? 'active' : ''}" onclick="toggleListFinance(${lIdx})">üëÅÔ∏è</button>
                    </div>
                    
                    <div class="list-finance-controls finance-ui">
                        <div style="width:80px;">
                           <button class="btn-subtle" style="border-radius:50%; width:24px; height:24px; margin: 0 auto; display: block;" onclick="resetListPrices(${lIdx})" title="R√©initialiser les prix">‚ü≥</button>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:center; gap:2px; width:65px;">
                            <input type="number" step="1" class="discount-input" style="width:40px !important;" value="${list.globalDiscount}" onchange="updateGlobalDiscount(${lIdx}, this.value)">
                            <button class="btn-apply-all" title="Appliquer √† tout" onclick="applyDiscountToAll(${lIdx})">‚ü≥</button>
                        </div>
                        <div class="total-list-display" id="total-display-${lIdx}">0,00</div>
                    </div>

                    <div style="display:flex; gap:2px; margin-left:10px;">
                        <button class="btn btn-subtle" style="width:24px; height:24px; font-size:10px;" onclick="renameList(${lIdx})">‚úé</button>
                        <button class="btn btn-subtle" style="width:24px; height:24px; font-size:10px;" onclick="duplicateList(${lIdx})">‚ùê</button>
                        <button class="btn btn-danger" style="width:24px; height:24px; font-size:10px;" onclick="deleteList(${lIdx})">√ó</button>
                    </div>
                </div>

                <div style="position:relative; margin-bottom:10px;">
                    <input type="text" class="search-input" placeholder="Chercher ou nommer un item..." style="width:100%;" oninput="searchInList(this, '${list.invSourceId}', ${lIdx})">
                    <div class="suggestions" style="display:none;"></div>
                    <div class="pre-add-container">
                        <div class="qty-picker">
                            <button onclick="changePreAddQty(${lIdx}, -1)">-</button>
                            <input type="number" id="pre-qty-${lIdx}" class="qty-field" value="1">
                            <button onclick="changePreAddQty(${lIdx}, 1)">+</button>
                        </div>
                        <button class="btn btn-add" style="flex:1; padding:5px;" onclick="addItemFromSearch(${lIdx})">AJOUTER</button>
                    </div>
                </div>
                <div id="items-list-${lIdx}"></div>
            `;
            wrapper.appendChild(div);
            renderListItems(lIdx);
        });
    }

    function resetListPrices(lIdx) {
        if(!confirm("R√©initialiser tous les prix de cette liste aux valeurs d'origine ?")) return;
        const p = projects.find(proj => proj.id === currentProjId);
        const list = p.lists[lIdx];
        const inv = inventories.find(i => i.id === list.invSourceId);
        list.selections.forEach(sel => {
            if(sel.itemId) {
                const invItem = inv.items.find(i => i.id === sel.itemId);
                if(invItem) sel.customPrice = invItem.price;
            } else { sel.customPrice = 0; }
        });
        save(); renderListItems(lIdx);
    }

    function renameList(lIdx) {
        const p = projects.find(proj => proj.id === currentProjId);
        const n = prompt("Nom de la liste :", p.lists[lIdx].name);
        if(n) { p.lists[lIdx].name = n; save(); renderProjectLists(); }
    }

    function duplicateList(lIdx) {
        const p = projects.find(proj => proj.id === currentProjId);
        const original = p.lists[lIdx];
        const clone = JSON.parse(JSON.stringify(original));
        clone.id = 'li_' + Date.now();
        clone.name += " (Copie)";
        p.lists.push(clone);
        save(); renderProjectLists();
    }

    function toggleListFinance(lIdx) {
        const p = projects.find(proj => proj.id === currentProjId);
        p.lists[lIdx].hideFinance = !p.lists[lIdx].hideFinance;
        save(); renderProjectLists();
    }

    function updateGlobalDiscount(lIdx, val) {
        const p = projects.find(proj => proj.id === currentProjId);
        p.lists[lIdx].globalDiscount = parseFloat(val) || 0;
        save();
    }

    function applyDiscountToAll(lIdx) {
        const p = projects.find(proj => proj.id === currentProjId);
        const list = p.lists[lIdx];
        list.selections.forEach(sel => { sel.discount = list.globalDiscount; });
        save(); renderListItems(lIdx);
    }

    function changePreAddQty(lIdx, val) {
        const input = document.getElementById(`pre-qty-${lIdx}`);
        let current = parseInt(input.value) || 1;
        input.value = Math.max(1, current + val);
    }

    function searchInList(input, invId, listIdx) {
        const val = input.value.toLowerCase();
        const suggBox = input.nextElementSibling;
        suggBox.innerHTML = '';
        if(val.length < 1) { suggBox.style.display = 'none'; listSearchState[listIdx] = null; return; }
        const inv = inventories.find(i => i.id === invId);
        const matches = inv.items.filter(i => !i.isSep && i.name.toLowerCase().includes(val));
        if(matches.length > 0) {
            suggBox.style.display = 'block';
            matches.forEach(m => {
                const d = document.createElement('div');
                d.style.padding = '10px'; d.style.cursor = 'pointer'; d.style.borderBottom = '1px solid #eee';
                d.textContent = m.name;
                d.onclick = () => { input.value = m.name; listSearchState[listIdx] = m.id; suggBox.style.display = 'none'; };
                suggBox.appendChild(d);
            });
        }
    }

    function addItemFromSearch(lIdx) {
        const p = projects.find(proj => proj.id === currentProjId);
        const list = p.lists[lIdx];
        const listContainer = document.querySelectorAll(`#listsWrapper .list-container`)[lIdx];
        const searchInput = listContainer.querySelector('.search-input');
        const qtyInput = document.getElementById(`pre-qty-${lIdx}`);
        const itemId = listSearchState[lIdx];
        const itemName = searchInput.value.trim();
        const qty = parseInt(qtyInput.value) || 1;
        if(!itemName) return;
        if(itemId) {
            const existing = list.selections.find(s => s.itemId === itemId);
            if(existing) existing.qty += qty;
            else list.selections.push({ itemId: itemId, qty: qty, discount: list.globalDiscount });
        } else {
            list.selections.push({ itemId: null, manualName: itemName, qty: qty, discount: list.globalDiscount, customPrice: 0 });
        }
        searchInput.value = ''; qtyInput.value = 1; listSearchState[lIdx] = null;
        save(); renderListItems(lIdx);
    }

    function renderListItems(lIdx) {
        const p = projects.find(proj => proj.id === currentProjId);
        const list = p.lists[lIdx];
        const inv = inventories.find(i => i.id === list.invSourceId);
        const container = document.getElementById(`items-list-${lIdx}`);
        container.innerHTML = '';
        let listGrandTotal = 0;

        inv.items.forEach(invItem => {
            const sel = list.selections.find(s => s.itemId === invItem.id);
            if(invItem.isSep) {
                const sep = document.createElement('div');
                sep.className = 'list-separator-view';
                sep.textContent = invItem.name;
                container.appendChild(sep);
            } else if(sel) {
                listGrandTotal += renderSingleItemRow(container, lIdx, sel, invItem.name, invItem.price, list.globalDiscount, list.hideFinance);
            }
        });

        list.selections.filter(s => s.itemId === null).forEach(sel => {
            listGrandTotal += renderSingleItemRow(container, lIdx, sel, sel.manualName, 0, list.globalDiscount, list.hideFinance);
        });

        const totalDisplay = document.getElementById(`total-display-${lIdx}`);
        if(totalDisplay) totalDisplay.textContent = listGrandTotal.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function renderSingleItemRow(container, lIdx, sel, displayName, basePrice, globalDisc, isHidden) {
        if (sel.discount === undefined) sel.discount = globalDisc;
        if (sel.customPrice === undefined) sel.customPrice = basePrice;
        const currentPrice = sel.customPrice;
        const lineTotal = sel.qty * currentPrice * (1 - (sel.discount / 100));
        
        const isDiscountOverridden = Math.abs(sel.discount - globalDisc) > 0.01;
        const isPriceOverridden = Math.abs(currentPrice - basePrice) > 0.001;

        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-grid-row';
        itemDiv.style.padding = '8px 0';
        itemDiv.style.borderBottom = '1px solid #f0f0f0';
        
        let html = `
            <div style="min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em;">
                <strong>${sel.qty}x</strong> ${displayName} 
                <button class="btn-delete-item" onclick="removeItem(${lIdx}, ${sel.itemId}, '${sel.manualName || ''}')">√ó</button>
            </div>`;

        if (!isHidden) {
            html += `
            <div class="finance-ui">
                <input type="number" step="0.01" class="price-input no-spinners ${isPriceOverridden ? 'override' : ''}" value="${currentPrice.toFixed(2)}" onchange="updateItemPrice(${lIdx}, ${sel.itemId}, '${sel.manualName || ''}', this.value)">
            </div>
            <div class="finance-ui">
                <input type="number" step="1" class="discount-input ${isDiscountOverridden ? 'override' : ''}" value="${sel.discount}" onchange="updateItemDiscount(${lIdx}, ${sel.itemId}, '${sel.manualName || ''}', this.value)">
            </div>
            <div class="finance-ui price-col-cell" style="font-weight:bold;">${lineTotal.toFixed(2)}</div>`;
        }

        html += `
            <div style="display:flex; gap:4px; justify-content: flex-end;">
                <button class="btn btn-subtle ipad-qty-btn" onclick="updateQty(${lIdx}, ${sel.itemId}, '${sel.manualName || ''}', 1)">+</button>
                <button class="btn btn-subtle ipad-qty-btn" onclick="updateQty(${lIdx}, ${sel.itemId}, '${sel.manualName || ''}', -1)">-</button>
            </div>`;
        
        itemDiv.innerHTML = html;
        container.appendChild(itemDiv);
        return lineTotal;
    }

    function updateItemPrice(lIdx, itemId, manualName, val) {
        const p = projects.find(proj => proj.id === currentProjId);
        const list = p.lists[lIdx];
        const sel = list.selections.find(s => s.itemId === itemId && (itemId !== null || s.manualName === manualName));
        if(sel) { sel.customPrice = parseFloat(val) || 0; save(); renderListItems(lIdx); }
    }

    function updateItemDiscount(lIdx, itemId, manualName, val) {
        const p = projects.find(proj => proj.id === currentProjId);
        const list = p.lists[lIdx];
        const sel = list.selections.find(s => s.itemId === itemId && (itemId !== null || s.manualName === manualName));
        if(sel) { sel.discount = parseFloat(val) || 0; save(); renderListItems(lIdx); }
    }

    function updateQty(lIdx, itemId, manualName, change) {
        const p = projects.find(proj => proj.id === currentProjId);
        const list = p.lists[lIdx];
        const sel = list.selections.find(s => s.itemId === itemId && (itemId !== null || s.manualName === manualName));
        if(sel) { sel.qty += change; if(sel.qty <= 0) removeItem(lIdx, itemId, manualName); }
        save(); renderListItems(lIdx);
    }

    function removeItem(lIdx, itemId, manualName) {
        const p = projects.find(proj => proj.id === currentProjId);
        const list = p.lists[lIdx];
        list.selections = list.selections.filter(s => !(s.itemId === itemId && (itemId !== null || s.manualName === manualName)));
        save(); renderListItems(lIdx);
    }

    function toggleImportExport() { 
        const s = document.getElementById('importSection');
        const a = document.getElementById('importText');
        if(s.style.display === 'none') {
            const inv = inventories.find(i => i.id === currentInvId);
            let txt = "";
            inv.items.forEach(i => {
                if(i.isSep) txt += "\t\t\n\t\t\n"; 
                else txt += `${i.name}\t${i.price}\t${i.stock}\n`;
            });
            a.value = txt;
            s.style.display = 'block';
        } else s.style.display = 'none';
    }

    function processImport() {
        if(!confirm("√âcraser l'inventaire ?")) return;
        const inv = inventories.find(i => i.id === currentInvId);
        const rows = document.getElementById('importText').value.split('\n');
        let newItems = [];
        let emptyCount = 0;
        rows.forEach((r, idx) => {
            const c = r.split('\t');
            const name = c[0] ? c[0].trim() : "";
            if(!name) {
                emptyCount++;
                if(emptyCount === 2) { 
                    newItems.push({ id: Date.now()+idx, name: "--- SECTION ---", isSep: true });
                    emptyCount = 0;
                }
            } else {
                emptyCount = 0;
                let cleanPrice = (c[1] || "0").replace(/[$\s\u00A0]/g, "").replace(",", ".");
                newItems.push({ id: Date.now()+idx, name: name, price: parseFloat(cleanPrice)||0, stock: parseInt(c[2])||1, isSep: false });
            }
        });
        inv.items = newItems;
        save(); renderInventoryEditor(); document.getElementById('importSection').style.display = 'none';
    }

    function renderFinale() {
        const p = projects.find(proj => proj.id === currentProjId);
        const container = document.getElementById('finaleContent');
        container.innerHTML = '';
        p.lists.forEach((list, lIdx) => {
            const inv = inventories.find(i => i.id === list.invSourceId);
            let html = `
                <div style="display:flex; align-items:center; gap:10px; margin-top:20px;">
                    <h3 style="margin:0;">${list.name}</h3>
                    <button class="btn btn-subtle" onclick="copySingleList(${lIdx})" style="width:24px; height:24px; font-size:10px;">üìã</button>
                </div>
                <div class="table-container"><table>`;
            inv.items.forEach(invItem => {
                const sel = list.selections.find(s => s.itemId === invItem.id);
                if(invItem.isSep) html += `<tr style="background:#f1f1f1;"><td colspan="2" style="height:30px;"></td></tr>`;
                else if(sel) html += `<tr><td style="width:50px; font-weight:bold; text-align:center;">${sel.qty}</td><td>${invItem.name}</td></tr>`;
            });
            list.selections.filter(s => s.itemId === null).forEach(sel => {
                html += `<tr><td style="width:50px; font-weight:bold; text-align:center;">${sel.qty}</td><td>${sel.manualName}</td></tr>`;
            });
            html += `</table></div>`;
            container.innerHTML += html;
        });
    }

    function copySingleList(lIdx) {
        const p = projects.find(proj => proj.id === currentProjId);
        const list = p.lists[lIdx];
        const inv = inventories.find(i => i.id === list.invSourceId);
        let txt = "";
        inv.items.forEach(invItem => {
            const sel = list.selections.find(s => s.itemId === invItem.id);
            if(invItem.isSep) txt += "\u00A0\t\u00A0\n\u00A0\t\u00A0\n";
            else if(sel) txt += `${sel.qty}\t${invItem.name}\n`;
        });
        list.selections.filter(s => s.itemId === null).forEach(sel => {
            txt += `${sel.qty}\t${sel.manualName}\n`;
        });
        navigator.clipboard.writeText(txt);
    }

    function copyAllLists() {
        let txt = "";
        const p = projects.find(proj => proj.id === currentProjId);
        p.lists.forEach(list => {
            txt += `--- ${list.name.toUpperCase()} ---\n`;
            const inv = inventories.find(i => i.id === list.invSourceId);
            inv.items.forEach(invItem => {
                const sel = list.selections.find(s => s.itemId === invItem.id);
                if(invItem.isSep) txt += "\u00A0\t\u00A0\n\u00A0\t\u00A0\n";
                else if(sel) txt += `${sel.qty}\t${invItem.name}\n`;
            });
            list.selections.filter(s => s.itemId === null).forEach(sel => {
                txt += `${sel.qty}\t${sel.manualName}\n`;
            });
            txt += "\n";
        });
        navigator.clipboard.writeText(txt);
    }

    function save() {
        localStorage.setItem('vt_v24_projs', JSON.stringify(projects));
        localStorage.setItem('vt_v24_invs', JSON.stringify(inventories));
    }
    function deleteInv(id) { if(confirm("Supprimer ?")) { inventories = inventories.filter(i => i.id !== id); save(); renderInventories(); } }
    function deleteProj(id) { if(confirm("Supprimer ?")) { projects = projects.filter(p => p.id !== id); save(); renderProjects(); } }
    function deleteList(idx) { if(confirm("Supprimer la liste ?")) { projects.find(p=>p.id===currentProjId).lists.splice(idx,1); save(); renderProjectLists(); } }
    function clearCurrentInventory() { if(confirm("Tout effacer ?")) { inventories.find(i=>i.id===currentInvId).items = []; save(); renderInventoryEditor(); } }

    renderProjects();
</script>
</body>
</html>
